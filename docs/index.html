<!DOCTYPE html>
<html>
<head>
    <!-- Origin Trial Token, feature = WebUSB (For Chrome M57+), origin = https://webusb.github.io, expires = 2017-06-19 -->
    <meta http-equiv="origin-trial" data-feature="WebUSB (For Chrome M57+)" data-expires="2017-06-19" content="Ag83MurQOa5N4SKRCqqtSlbycfe08s5LgUiqEI7J3jTk2NEIpRp7SLPz2i+EBDuXyf+AeRMdD6BI++kTSJmGzQEAAABReyJvcmlnaW4iOiJodHRwczovL3dlYnVzYi5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IldlYlVTQjIiLCJleHBpcnkiOjE0OTc4OTM2OTV9">
    <title>Console</title>
    <script src="hterm_all.js"></script>
    <script src="serial.js"></script>
    <script src="console.js"></script>

    <style>
        html {
            height: 100%;
        }

        body {
            position: absolute;
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0px;
            padding: 0px;
        }

        #terminal {
            display: block;
            position: relative;
            height: 100%;
            width: 100%;
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>

<body>
    <div id='terminal'></div>
    <script>
        function initContent(io) {
            const ver = lib.resource.getData('hterm/changelog/version');
            const date = lib.resource.getData('hterm/changelog/date');
            const pkg = `hterm ${ver} (${date})`;
            /* eslint-disable quotes */
            io.println("\r\n\\r\n\
                                   Welcome to hterm!\r\n\
                    Press F11 to go fullscreen to use all shortcuts.\r\n\
                           Running " + pkg + ".\r\n\
");
            /* eslint-enable quotes */
        }

        // Load translations if available.
        lib.registerInit('load messages', async () => {
        });

        function setupHterm() {
            const term = new hterm.Terminal();

            term.onTerminalReady = function () {
                const io = this.io.push();
                function printPrompt() {
                    io.print(
                        '\x1b[38:2:51:105:232mspihub>' +
                        '\x1b[0m ');
                }

                io.onVTKeystroke = (string) => {
                    switch (string) {
                        case '\r':
                            io.println('');
                            printPrompt();
                            break;
                        case '\x7f':
                            // \x08 = backspace, \x1b[K = 'Erase in line'.
                            io.print('\x08\x1b[K');
                            break;
                        default:
                            io.print(string);
                            break;
                    }
                };
                io.sendString = io.print;
                initContent(io);
                printPrompt();
                this.setCursorVisible(true);

                this.keyboard.bindings.addBinding('F11', 'PASS');
                this.keyboard.bindings.addBinding('Ctrl+R', 'PASS');
            };
            term.decorate(document.querySelector('#terminal'));
            term.installKeyboard();

            term.contextMenu.setItems([
                { name: 'Terminal Reset', action: () => term.reset() },
                { name: 'Terminal Clear', action: () => term.clear() },
                { name: hterm.ContextMenu.SEPARATOR },
                {
                    name: 'Homepage', action: function () {
                        lib.f.openWindow(
                            'https://chromium.googlesource.com/apps/libapps/+/HEAD/hterm/README.md',
                            '_blank');
                    }
                },
                {
                    name: 'FAQ', action: function () {
                        lib.f.openWindow('https://goo.gl/muppJj', '_blank');
                    }
                },
            ]);

            // Useful for console debugging.
            window.term_ = term;
        }

        window.onload = async function () {
            await lib.init();
            setupHterm();
        };
    </script>

</body>
</html>